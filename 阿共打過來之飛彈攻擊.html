<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£›å½ˆæ¨¡æ“¬å™¨ï¼šCEP çš„ç¾å¯¦</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- å¼•å…¥ Babel ç”¨æ–¼ç€è¦½å™¨å…§ç·¨è­¯ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* è‡ªå®šç¾©æ·¡å…¥å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. å…§å»º SVG åœ–ç¤ºå…ƒä»¶ ---
        const Icons = {
            Crosshair: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/>
                </svg>
            ),
            Target: ({ className, size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>
                </svg>
            ),
            Info: ({ className, size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
            ),
            RotateCcw: ({ className, size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                </svg>
            ),
            Home: ({ className, size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
            ),
            Play: ({ className, size = 24, fill = "none" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
            ),
            BookOpen: ({ className, size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                </svg>
            ),
            ChevronDown: ({ className, size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            ),
            RefreshCw: ({ className, size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
            ),
            X: ({ className, size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            ),
            HelpCircle: ({ className, size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            ),
            ArrowRight: ({ className, size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>
                </svg>
            ),
            MousePointer2: ({ className, size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/>
                </svg>
            )
        };

        // --- 2. éŠæˆ²å¸¸æ•¸èˆ‡æ•¸æ“š ---
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 500;
        const SCALE = 2; // 1px = 1å…¬å°º

        const PROBABILITY_DATA = [
            { count: 1, miss: "50%", hit: "50%" },
            { count: 2, miss: "25% (0.5Â²)", hit: "75%" },
            { count: 3, miss: "12.5% (0.5Â³)", hit: "87.5%" },
            { count: 4, miss: "6.25%", hit: "93.75%" },
            { count: 5, miss: "3.125%", hit: "96.875%" }
        ];

        // Level 1: è·‘é“åœ°åœ– (ç”¨ä½œåŸºç¤)
        const RUNWAY_WIDTH = 600;
        const RUNWAY_HEIGHT = 40; 
        const RUNWAY_OBJ = {
            id: 'runway',
            name: 'æ©Ÿå ´è·‘é“',
            x: (CANVAS_WIDTH - RUNWAY_WIDTH) / 2,
            y: (CANVAS_HEIGHT - RUNWAY_HEIGHT) / 2,
            width: RUNWAY_WIDTH,
            height: RUNWAY_HEIGHT,
            type: 'military',
            color: '#6b7280'
        };

        // Level 2: åŸé® (å›ºå®šé…ç½®)
        const TOWN_WIDTH = 400;
        const TOWN_HEIGHT = 300;
        const TOWN_X = (CANVAS_WIDTH - TOWN_WIDTH) / 2;
        const TOWN_Y = (CANVAS_HEIGHT - TOWN_HEIGHT) / 2;

        const TOWN_OBJECTS = [
            { id: 'enemy_hq', name: 'æ•µè»æŒ‡æ®æ‰€', x: CANVAS_WIDTH/2 - 20, y: CANVAS_HEIGHT/2 - 20, width: 40, height: 40, type: 'military', color: '#dc2626' },
            { id: 'h1', name: 'æ°‘å®…', x: TOWN_X + 50, y: TOWN_Y + 50, width: 30, height: 30, type: 'civilian', color: '#16a34a' },
            { id: 'h2', name: 'æ°‘å®…', x: TOWN_X + 100, y: TOWN_Y + 80, width: 30, height: 30, type: 'civilian', color: '#16a34a' },
            { id: 'h3', name: 'æ°‘å®…', x: TOWN_X + 300, y: TOWN_Y + 60, width: 30, height: 30, type: 'civilian', color: '#16a34a' },
            { id: 'h4', name: 'æ°‘å®…', x: TOWN_X + 60, y: TOWN_Y + 200, width: 30, height: 30, type: 'civilian', color: '#16a34a' },
            { id: 'h5', name: 'æ°‘å®…', x: TOWN_X + 250, y: TOWN_Y + 220, width: 30, height: 30, type: 'civilian', color: '#16a34a' },
            { id: 'h6', name: 'æ°‘å®…', x: TOWN_X + 320, y: TOWN_Y + 180, width: 30, height: 30, type: 'civilian', color: '#16a34a' },
            { id: 'h7', name: 'æ°‘å®…', x: TOWN_X + 150, y: TOWN_Y + 150, width: 30, height: 30, type: 'civilian', color: '#16a34a' },
            { id: 'h8', name: 'æ°‘å®…', x: TOWN_X + 200, y: TOWN_Y + 40, width: 30, height: 30, type: 'civilian', color: '#16a34a' },
            { id: 'h9', name: 'æ°‘å®…', x: TOWN_X + 20, y: TOWN_Y + 120, width: 30, height: 30, type: 'civilian', color: '#16a34a' },
            { id: 'h10', name: 'æ°‘å®…', x: TOWN_X + 350, y: TOWN_Y + 250, width: 30, height: 30, type: 'civilian', color: '#16a34a' },
            { id: 'h11', name: 'æ°‘å®…', x: TOWN_X + 180, y: TOWN_Y + 260, width: 30, height: 30, type: 'civilian', color: '#16a34a' },
        ];

        // Level 3: åŸå¸‚ (åšæ„›ç‰¹å€ - çœŸå¯¦è·é›¢æ¯”ä¾‹)
        const CITY_CENTER_X = CANVAS_WIDTH / 2;
        const CITY_CENTER_Y = CANVAS_HEIGHT / 2;
        const CITY_OBJECTS = [
            { id: 'presidential_office', name: 'ç¸½çµ±åºœ (ç›®æ¨™)', x: 340, y: 210, width: 120, height: 80, type: 'military', color: '#ef4444' },
            { id: 'school', name: 'åŒ—ä¸€å¥³ä¸­', x: 480, y: 310, width: 100, height: 80, type: 'civilian', color: '#10b981' },
            { id: 'judicial', name: 'å¸æ³•é™¢', x: 320, y: 320, width: 90, height: 60, type: 'civilian', color: '#059669' },
            { id: 'museum', name: 'åœ‹å²é¤¨', x: 150, y: 220, width: 70, height: 70, type: 'civilian', color: '#34d399' },
            { id: 'park', name: 'äºŒäºŒå…«å…¬åœ’', x: 540, y: 40, width: 120, height: 100, type: 'civilian', color: '#86efac' }
        ];

        const LEVELS = [
            {
                id: 1,
                title: "Level 1: è§€å¿µè§£æ - ä»€éº¼æ˜¯ CEPï¼Ÿ",
                shortTitle: "è§€å¿µè§£æï¼šä»€éº¼æ˜¯ CEPï¼Ÿ",
                mapType: 'explanation',
                cep: 100,
                missileCount: 0,
                description: "ã€åŸºç¤è§€å¿µã€‘åœ¨é–‹å§‹æ¨¡æ“¬å‰ï¼Œæˆ‘å€‘å…ˆäº†è§£ä¸€å€‹æ ¸å¿ƒæ¦‚å¿µï¼šCEP (åœ“å‘¨èª¤å·®ç‡)ã€‚\né€™ä¸æ˜¯ã€Œå¿…ä¸­ã€çš„ä¿è­‰ï¼Œè€Œæ˜¯ä¸€å€‹ã€Œæ©Ÿç‡ã€çš„çµ±è¨ˆæ•¸æ“šã€‚\næœ¬é—œå¡å°‡æ¼”ç¤º CEP çš„çœŸå¯¦å®šç¾©ã€‚",
                quote: "CEPçš„æ¦‚å¿µæ˜¯æ©Ÿç‡...ä¸€æšå½ˆé“é£›å½ˆCEP 100mï¼Œä»£è¡¨ç™¼å°„å…©æšï¼Œçµ±è¨ˆä¸Šæœƒæœ‰ä¸€æšè½åœ¨åŠå¾‘100å…¬å°ºåœ“å…§ï¼Œè‹¥ç™¼å°„ä¸€ç™¾æšå°±æ˜¯æœ‰äº”åæšæœƒè½åœ¨é€™å€‹åœ“å½¢å…§ã€‚",
                color: "bg-indigo-500"
            },
            {
                id: 2,
                title: "Level 2: CEP çš„æ®˜é…·ç¾å¯¦",
                shortTitle: "ç¾å¯¦é«”é©—ï¼šè½Ÿç‚¸å°é®",
                mapType: 'town',
                cep: 100,
                userCanSetCep: true,
                missileCount: 10,
                description: "ã€å‘½ä¸­ç‡å¯¦é©—ã€‘ç›®æ¨™æ˜¯å°é®ä¸­å¤®çš„è»äº‹è¨­æ–½ï¼ˆç´…è‰²ï¼‰ï¼Œå‘¨åœæœ‰å›ºå®šåˆ†ä½ˆçš„æ°‘å®…ï¼ˆç¶ è‰²ï¼‰ã€‚\nè«‹è©¦è‘—åˆ‡æ›ã€Œå‚³èªª (CEP=0)ã€èˆ‡ã€Œç¾å¯¦ (CEP=100)ã€æ¨¡å¼ï¼Œé«”é©—åœ¨èª¤å·®ä¸‹è¦é¿é–‹æ°‘å®…æ“Šä¸­ç›®æ¨™æœ‰å¤šå›°é›£ã€‚",
                quote: "é£›å½ˆåœ¨è·‘é“ä¸Šç©ºçˆ†ç‚¸...å¦‚æœè½åˆ°æ°‘å®…ï¼ŒçœŸçš„æœƒé€ æˆæ¯€æã€‚ä¸€èˆ¬å¹³æˆ¿æˆ–æ˜¯é€å¤©åï¼Œå¤§æ¦‚åªèƒ½èº²åˆ°åœ°ä¸‹å®¤æ‰èƒ½é€ƒéä¸€åŠ«ã€‚",
                color: "bg-blue-500"
            },
            {
                id: 3,
                title: "Level 3: è½Ÿç‚¸ç¸½çµ±åºœ (é™„å¸¶æå‚·)",
                shortTitle: "å¯¦æˆ°æ¨¡æ“¬ï¼šåšæ„›ç‰¹å€",
                mapType: 'city',
                cep: 100,
                missileCount: 15,
                description: "ã€å¯¦æˆ°æ¨¡æ“¬ã€‘å¦‚æœç›®æ¨™æ˜¯ç¸½çµ±åºœï¼Ÿ\nåœ°åœ–æ›æˆåšæ„›ç‰¹å€ã€‚åœ¨ç¾å¯¦ CEP ä¸‹ï¼Œè¦ç‚¸æ¯€ç¸½çµ±åºœï¼Œä½ æ•¢ä¿è­‰ä¸ç‚¸åˆ°æ—é‚Šçš„åŒ—ä¸€å¥³ä¸­æˆ–é†«é™¢å—ï¼Ÿ(1px = 1å…¬å°º)",
                quote: "ç„æº–éƒ½å¸‚å€åŸŸå…§çš„æ”¿åºœã€è»äº‹æ©Ÿé—œï¼Œä¸€å€‹ä¸å°å¿ƒä¸å°±ç ¸åˆ°æ—é‚Šçš„æ°‘é–“å–®ä½...å³ä¸‹è§’å¥½åƒæœ‰ä¸€é–“å­¸æ ¡ã€‚",
                color: "bg-slate-700"
            }
        ];

        function App() {
            const canvasRef = useRef(null);
            const [currentLevel, setCurrentLevel] = useState(0);
            const [missilesLeft, setMissilesLeft] = useState(LEVELS[0].missileCount);
            const [craters, setCraters] = useState([]);
            const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
            const [logs, setLogs] = useState([]);
            const [gameState, setGameState] = useState('menu');
            const [showBriefing, setShowBriefing] = useState(true);
            
            const [selectedCep, setSelectedCep] = useState(LEVELS[0].cep);
            const [explanationMissileCount, setExplanationMissileCount] = useState(1);
            const [showCepModal, setShowCepModal] = useState(false);

            // Level 1: å½ˆè‘—é»ç‹€æ…‹
            const [explanationDots, setExplanationDots] = useState([]);
            
            // åˆå§‹åŒ–é—œå¡
            const startLevel = (levelIndex) => {
                setCurrentLevel(levelIndex);
                const level = LEVELS[levelIndex];
                setMissilesLeft(level.missileCount);
                setSelectedCep(level.cep);
                setCraters([]);
                setLogs([]);
                setGameState('playing');
                setShowBriefing(true);
                setShowCepModal(false);
                
                // Level 1 é‡ç½®
                if (level.mapType === 'explanation') {
                    setExplanationDots([]);
                    setExplanationMissileCount(1);
                    setTimeout(() => simulateOneVolley(1), 100);
                }
            };

            const returnToMenu = () => {
                setGameState('menu');
            };

            // Level 1: æ¨¡æ“¬å°„æ“Š (å–®æ¬¡é¡¯ç¤º)
            const simulateOneVolley = (count) => {
                const centerX = CANVAS_WIDTH / 2;
                const centerY = CANVAS_HEIGHT / 2 - 110; 
                const cepRadius = 70; 
                
                const newDots = [];

                for (let i = 0; i < count; i++) {
                    const isInside = Math.random() < 0.5;
                    let r, theta;
                    theta = Math.random() * 2 * Math.PI;
                    
                    if (isInside) {
                        r = Math.sqrt(Math.random()) * cepRadius;
                    } else {
                        r = cepRadius + Math.sqrt(Math.random()) * (cepRadius * 1.5);
                    }

                    const x = centerX + r * Math.cos(theta);
                    const y = centerY + r * Math.sin(theta);
                    newDots.push({ x, y, inside: isInside });
                }
                setExplanationDots(newDots);
            };

            // ç›£è½èªªæ˜æ•¸é‡æ”¹è®Š
            useEffect(() => {
                if (gameState === 'playing' && LEVELS[currentLevel].mapType === 'explanation') {
                    simulateOneVolley(explanationMissileCount);
                }
            }, [explanationMissileCount, gameState, currentLevel]);

            // ç¹ªåœ–é‚è¼¯
            useEffect(() => {
                if (gameState === 'menu' || gameState === 'bibliography') return;

                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (!ctx) return;
                
                const config = LEVELS[currentLevel];

                // æ¸…ç©ºèƒŒæ™¯
                ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                ctx.fillStyle = '#e5e7eb';
                ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

                // --- LEVEL 1: è§€å¿µæ¼”ç¤º ---
                if (config.mapType === 'explanation') {
                    const cx = CANVAS_WIDTH / 2;
                    const cy = CANVAS_HEIGHT / 2 - 110; 
                    const r = 70;

                    // ç›®æ¨™é»
                    ctx.beginPath();
                    ctx.arc(cx, cy, 3, 0, Math.PI * 2);
                    ctx.fillStyle = '#999';
                    ctx.fill();
                    
                    // CEP åœ“åœˆ
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, 0, Math.PI * 2);
                    ctx.strokeStyle = '#3b82f6';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([10, 5]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.05)';
                    ctx.fill();

                    // æ–‡å­—
                    ctx.fillStyle = '#1e3a8a';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`CEP åŠå¾‘ (50% æ©Ÿç‡)`, cx, cy - r - 15);

                    // å½ˆè‘—é»
                    explanationDots.forEach(dot => {
                        ctx.beginPath();
                        ctx.arc(dot.x, dot.y, 6, 0, Math.PI * 2); 
                        if (dot.inside) {
                            ctx.fillStyle = 'rgba(239, 68, 68, 0.9)'; // ç´…è‰² (ä¸­)
                        } else {
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; // é»‘è‰² (ä¸ä¸­)
                        }
                        ctx.fill();
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    });
                    return; 
                }

                // --- LEVEL 2 & 3 ---
                let targets = [];
                if (config.mapType === 'town') {
                    // ç¹ªè£½åŸé®åº•æ¿
                    ctx.fillStyle = 'rgba(251, 191, 36, 0.2)'; 
                    ctx.fillRect(TOWN_X, TOWN_Y, TOWN_WIDTH, TOWN_HEIGHT);
                    ctx.strokeStyle = '#d97706';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(TOWN_X, TOWN_Y, TOWN_WIDTH, TOWN_HEIGHT);
                    
                    // å°ºå¯¸
                    ctx.fillStyle = '#d97706';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${TOWN_WIDTH}m`, TOWN_X + TOWN_WIDTH / 2, TOWN_Y - 5);
                    ctx.textAlign = 'right';
                    ctx.fillText(`${TOWN_HEIGHT}m`, TOWN_X - 5, TOWN_Y + TOWN_HEIGHT / 2);
                    
                    targets = TOWN_OBJECTS;
                } else if (config.mapType === 'city') {
                    // ç¹ªè£½è¡—é“
                    ctx.strokeStyle = '#d1d5db';
                    ctx.lineWidth = 10;
                    ctx.beginPath();
                    ctx.moveTo(CITY_CENTER_X - 120, 0); ctx.lineTo(CITY_CENTER_X - 120, CANVAS_HEIGHT);
                    ctx.moveTo(CITY_CENTER_X + 20, 0); ctx.lineTo(CITY_CENTER_X + 20, CANVAS_HEIGHT);
                    ctx.moveTo(0, CITY_CENTER_Y); ctx.lineTo(CANVAS_WIDTH, CITY_CENTER_Y);
                    ctx.moveTo(0, CITY_CENTER_Y + 110); ctx.lineTo(CANVAS_WIDTH, CITY_CENTER_Y + 110);
                    ctx.stroke();
                    targets = CITY_OBJECTS;
                } else if (config.mapType === 'runway') {
                    targets = [RUNWAY_OBJ];
                    // è·‘é“ç·š
                    ctx.strokeStyle = '#ffffff';
                    ctx.setLineDash([20, 10]);
                    ctx.beginPath();
                    ctx.moveTo(RUNWAY_OBJ.x, RUNWAY_OBJ.y + RUNWAY_OBJ.height / 2);
                    ctx.lineTo(RUNWAY_OBJ.x + RUNWAY_OBJ.width, RUNWAY_OBJ.y + RUNWAY_OBJ.height / 2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }

                // ç¹ªè£½ç‰©ä»¶
                targets.forEach(obj => {
                    ctx.fillStyle = obj.color;
                    ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
                    ctx.strokeStyle = 'rgba(0,0,0,0.2)';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(obj.x, obj.y, obj.width, obj.height);
                    
                    ctx.fillStyle = 'white';
                    if (obj.type === 'town_area') ctx.fillStyle = '#b45309'; 
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    // é¡¯ç¤ºæ‰€æœ‰åç¨±
                    ctx.fillText(obj.name, obj.x + obj.width / 2, obj.y + obj.height / 2 + 4);
                });

                // ç¹ªè£½å½ˆå‘
                craters.forEach(crater => {
                    ctx.beginPath();
                    ctx.arc(crater.x, crater.y, 15, 0, Math.PI * 2);
                    if (crater.hitResult === 'civilian') ctx.fillStyle = 'rgba(239, 68, 68, 0.8)';
                    else if (crater.hitResult === 'hit') ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    else ctx.fillStyle = 'rgba(107, 114, 128, 0.5)';
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                });

                // ç¹ªè£½æº–å¿ƒ
                if (gameState === 'playing' && !showBriefing && missilesLeft > 0) {
                    ctx.beginPath();
                    ctx.arc(mousePos.x, mousePos.y, 5, 0, Math.PI * 2);
                    ctx.fillStyle = 'red';
                    ctx.fill();
                    
                    if (selectedCep > 0) {
                        ctx.beginPath();
                        ctx.arc(mousePos.x, mousePos.y, selectedCep * SCALE / 2, 0, Math.PI * 2);
                        ctx.strokeStyle = 'rgba(239, 68, 68, 0.4)';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        ctx.fillStyle = 'rgba(239, 68, 68, 0.05)';
                        ctx.fill();
                        ctx.fillStyle = '#dc2626';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText(`CEP: ${selectedCep}m`, mousePos.x + 10, mousePos.y - 10);
                    } else {
                        ctx.fillStyle = '#dc2626';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText(`CEP: 0m`, mousePos.x + 10, mousePos.y - 10);
                    }
                }
            }, [craters, mousePos, currentLevel, gameState, showBriefing, missilesLeft, selectedCep, explanationDots]);

            // æ»‘é¼ ç§»å‹•
            const handleMouseMove = (e) => {
                if (gameState !== 'playing' || LEVELS[currentLevel].mapType === 'explanation') return;
                const rect = canvasRef.current?.getBoundingClientRect();
                if (rect) {
                    setMousePos({
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    });
                }
            };

            // ç™¼å°„é£›å½ˆ
            const handleFire = () => {
                if (missilesLeft <= 0 || showBriefing || LEVELS[currentLevel].mapType === 'explanation') return;
                setMissilesLeft(prev => prev - 1);

                let deviationX = 0;
                let deviationY = 0;

                if (selectedCep > 0) {
                    const angle = Math.random() * Math.PI * 2;
                    const r = Math.sqrt(-2 * Math.log(Math.random() || 0.001)) * (selectedCep * SCALE / 1.1774); 
                    deviationX = Math.cos(angle) * r;
                    deviationY = Math.sin(angle) * r;
                }

                const hitX = mousePos.x + deviationX;
                const hitY = mousePos.y + deviationY;

                let hitResult = 'miss';
                let hitTargetName = '';
                const config = LEVELS[currentLevel];
                
                let targets = [];
                if (config.mapType === 'town') targets = TOWN_OBJECTS;
                else if (config.mapType === 'city') targets = CITY_OBJECTS;
                else if (config.mapType === 'runway') targets = [RUNWAY_OBJ];

                for (let i = targets.length - 1; i >= 0; i--) {
                    const t = targets[i];
                    if (hitX >= t.x && hitX <= t.x + t.width && hitY >= t.y && hitY <= t.y + t.height) {
                        if (t.type === 'military') hitResult = 'hit';
                        else if (t.type === 'civilian') hitResult = 'civilian';
                        else hitResult = 'miss';
                        hitTargetName = t.name;
                        break;
                    }
                }

                const newCrater = { x: hitX, y: hitY, hitResult, targetName: hitTargetName };
                setCraters(prev => [...prev, newCrater]);

                const devM = Math.round(Math.sqrt(deviationX**2 + deviationY**2) / SCALE);
                let logMsg = ``;
                if (hitResult === 'hit') logMsg = `ğŸ¯ å‘½ä¸­ç›®æ¨™ï¼š${hitTargetName}ï¼ (åå·®${devM}m)`;
                else if (hitResult === 'civilian') logMsg = `ğŸ˜± æ…˜åŠ‡ï¼èª¤æ“Šå¹³æ°‘ï¼š${hitTargetName}ï¼ (åå·®${devM}m)`;
                else logMsg = `ğŸ’¨ è„«é¶ (åå·®${devM}m)`;
                setLogs(prev => [logMsg, ...prev]);

                if (missilesLeft - 1 === 0) {
                    setTimeout(() => setGameState('summary'), 1000);
                }
            };

            const militaryHits = craters.filter(c => c.hitResult === 'hit').length;
            const civilianHits = craters.filter(c => c.hitResult === 'civilian').length;

            return (
                <div className="flex flex-col min-h-screen">
                    {/* Header */}
                    <div className="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0">
                        <div>
                            <h1 className="text-2xl font-bold flex items-center gap-2">
                                <Icons.Crosshair className="w-6 h-6" /> é£›å½ˆæ¨¡æ“¬å™¨ï¼šCEP çš„ç¾å¯¦
                            </h1>
                        </div>
                        <div className="flex gap-4 text-sm items-center">
                            {gameState !== 'menu' && (
                                <button onClick={returnToMenu} className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded border border-slate-600 transition-colors">
                                    <Icons.Home className="w-4 h-4" /> å›ä¸»é¸å–®
                                </button>
                            )}
                        </div>
                    </div>

                    {/* --- MENU --- */}
                    {gameState === 'menu' && (
                        <div className="flex-1 bg-gray-50 p-8 flex flex-col items-center justify-center animate-fadeIn">
                            <h2 className="text-3xl font-bold text-gray-800 mb-2">é¸æ“‡æ¨¡æ“¬é—œå¡</h2>
                            <p className="text-gray-500 mb-8">è«‹é¸æ“‡ä¸€å€‹æƒ…å¢ƒé–‹å§‹é«”é©— CEP èˆ‡å½ˆé“é£›å½ˆçš„ç‰¹æ€§</p>
                            
                            <div className="flex flex-col gap-6 w-full max-w-5xl">
                                {/* Levels Grid (3 Columns) */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
                                    {LEVELS.map((level, index) => (
                                        <button key={level.id} onClick={() => startLevel(index)} className="flex flex-col text-left bg-white rounded-xl shadow-md hover:shadow-xl hover:-translate-y-1 transition-all duration-300 border border-gray-100 overflow-hidden group">
                                            <div className={`${level.color} h-3 w-full`}></div>
                                            <div className="p-6 flex flex-col h-full">
                                                <h3 className="text-xl font-bold text-gray-800 mb-2 group-hover:text-blue-600 transition-colors">{level.shortTitle.split('ï¼š')[0]}</h3>
                                                <div className="text-sm font-medium text-gray-500 mb-4 pb-4 border-b border-gray-100">{level.shortTitle.split('ï¼š')[1]}</div>
                                                <p className="text-sm text-gray-600 leading-relaxed mb-6 flex-grow">{level.description.split('\n')[0]}</p>
                                                <div className="mt-auto flex justify-between items-center text-sm font-semibold text-gray-400 group-hover:text-gray-800">
                                                    <span className="flex items-center gap-1"><Icons.Target className="w-4 h-4"/> {level.missileCount > 0 ? level.missileCount + ' æšé£›å½ˆ' : 'è§€å¿µæ•™å­¸'}</span>
                                                    <span className="bg-gray-100 px-3 py-1 rounded-full group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">é–‹å§‹</span>
                                                </div>
                                            </div>
                                        </button>
                                    ))}
                                </div>

                                {/* Bibliography Button (Full Width) */}
                                <button onClick={() => setGameState('bibliography')} className="flex flex-col text-left bg-white rounded-xl shadow-md hover:shadow-xl hover:-translate-y-1 transition-all duration-300 border border-gray-100 overflow-hidden group w-full">
                                    <div className="bg-emerald-500 h-3 w-full"></div>
                                    <div className="p-6 flex flex-col h-full">
                                        <h3 className="text-xl font-bold text-gray-800 mb-2 group-hover:text-blue-600 transition-colors">ğŸ“– åƒè€ƒæ›¸ç›®</h3>
                                        <div className="text-sm font-medium text-gray-500 mb-4 pb-4 border-b border-gray-100">å»¶ä¼¸é–±è®€</div>
                                        <p className="text-sm text-gray-600 leading-relaxed mb-6 flex-grow">è»äº‹è¬ è¨€æ˜¯é€ æˆå°ç£å¤±æ•—ä¸»ç¾©çš„æº«åºŠ...<br/>äº†è§£æ›´å¤šé—œæ–¼å°æµ·å±€å‹¢çš„è¿·æ€ç ´è§£ã€‚</p>
                                        <div className="mt-auto flex justify-between items-center text-sm font-semibold text-gray-400 group-hover:text-gray-800">
                                            <span className="flex items-center gap-1"><Icons.BookOpen className="w-4 h-4"/> é–±è®€æ–‡ç« </span>
                                            <span className="bg-gray-100 px-3 py-1 rounded-full group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">å‰å¾€</span>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    )}

                    {/* --- BIBLIOGRAPHY VIEW --- */}
                    {gameState === 'bibliography' && (
                        <div className="flex-1 bg-white p-8 overflow-y-auto">
                            <div className="max-w-4xl mx-auto flex flex-col md:flex-row gap-8 items-start">
                                <div className="flex-1">
                                    <h2 className="text-2xl font-bold mb-6 text-slate-800 border-b pb-4">è»äº‹è¬ è¨€æ˜¯é€ æˆå°ç£å¤±æ•—ä¸»ç¾©çš„æº«åºŠ</h2>
                                    <div className="text-gray-700 space-y-4 leading-relaxed text-justify">
                                        <p>å°ç£å¤§é¸ä¹‹å‰ï¼Œå¿…æœƒå‡ºç¾è»äº‹è¬ è¨€å¤§é‡æ•£å¸ƒã€‚</p>
                                        <p>ä»¥å¾€éƒ½æ˜¯å°‘éƒ¨åˆ†çš„ä¸­åœ‹ç¶²æ°‘ï¼Œé…åˆå°ç£çµ±æ´¾è­è«·è²¶ä½å°ç£åœ‹è»ï¼Œæ•£æ’­å¹æ§è§£æ”¾è»å¯¦åŠ›çš„è¾²å ´æ–‡ã€‚ä½†åœ¨äºŒã€‡äºŒã€‡å¹´ç¸½çµ±å¤§é¸ï¼Œæ­¤è¶¨å‹¢å·²æ“´å¼µåˆ°ä¸€èˆ¬æ°‘çœ¾ï¼Œé€éLINEã€Facebookç­‰å°é–‰ç¾¤çµ„çš„ç‰¹æ€§ï¼Œä¸­åœ‹åŠ å¼·è³‡è¨Šæˆ°çš„åŠ›é“ï¼ŒåŠ›æ±‚è®“å°ç£æ°‘çœ¾æ™®éç›¸ä¿¡ï¼Œä¸­åœ‹è§£æ”¾è»çš„å¯¦åŠ›ä¸åƒ…å¯ä»¥ä¸‰å…©ä¸‹æ‰“æ•—å°ç£ï¼Œæ›´å¯ä»¥è¶…è‹±è¶•ç¾ï¼Œä¸å‡ºæ•¸å¹´å°±å¯æˆç‚ºæ–°éœ¸æ¬Šã€‚ä¹Ÿå°±æ˜¯è¦å°ç£äººæ—©é»èªæ¸…ç¾å¯¦ï¼Œå¿«å¿«æŠ•é™ã€‚</p>
                                        <p>ä½†ä»”ç´°æƒ³ä¸€æƒ³ï¼Œé€™é¡è¬ è¨€çš„ç›®çš„æ˜¯ä»€éº¼ï¼Ÿ</p>
                                        <p>è¬ è¨€æ˜¯å‹•æ–å°æ‰‹æ°‘å¿ƒçš„æ­¦å™¨ï¼Œæ˜¯åœ¨æ²’æœ‰æŠŠæ¡ã€ç„¡æ³•æœ‰æ•ˆç›´æ¥é€²æ“Šæ™‚ï¼Œé è¬ è¨€ä¾†å‹•æ–å°æ‰‹çš„ä¿¡å¿ƒï¼Œå‰µé€ æ‰“æ“Šçš„æœ‰åˆ©æ¢ä»¶ï¼Œç”šè‡³æƒ³ä»¥æåš‡çš„æ–¹å¼è®“å°ç£ä¹–ä¹–å°±ç¯„ã€‚å› æ­¤ï¼Œè¬ è¨€æ‰€ä»£è¡¨çš„æ˜¯é€ è¬ çš„ä¸€æ–¹æ²’æœ‰å¿…å‹çš„æŠŠæ¡ï¼Œè©¦åœ–é€éè¬ è¨€å‰µé€ å°å…¶æœ‰åˆ©çš„æƒ…å‹¢ã€‚</p>
                                    </div>
                                    <button onClick={returnToMenu} className="mt-8 flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-6 py-2 rounded-lg transition-colors">
                                        <Icons.Home className="w-4 h-4"/> è¿”å›ä¸»é¸å–®
                                    </button>
                                </div>
                                <div className="w-full md:w-1/3 shrink-0 flex flex-col items-center">
                                    {/* åœ–ç‰‡é ç•™ä½ç½® */}
                                    <div className="w-full bg-gray-100 rounded-lg shadow-lg overflow-hidden border border-gray-200">
                                        <img 
                                            src="./é˜¿å…±æ‰“éä¾†è©²æ€éº¼è¾¦.jpg" 
                                            alt="é˜¿å…±æ‰“ä¾†æ€éº¼è¾¦ æ›¸å½±" 
                                            className="w-full h-auto object-cover"
                                            onError={(e) => {
                                                e.target.onerror = null; 
                                                e.target.src="https://placehold.co/400x560/e2e8f0/475569?text=Image+Not+Found";
                                            }}
                                        />
                                    </div>
                                    <p className="text-sm text-gray-500 mt-3 text-center">
                                        åœ–ç‰‡èªªæ˜ï¼šé˜¿å…±æ‰“ä¾†æ€éº¼è¾¦<br/>
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- GAME --- */}
                    {gameState !== 'menu' && gameState !== 'bibliography' && (
                        <div className="relative flex-1 bg-gray-200">
                            <canvas ref={canvasRef} width={CANVAS_WIDTH} height={CANVAS_HEIGHT} className={`w-full h-full object-contain block ${LEVELS[currentLevel].mapType === 'explanation' ? 'cursor-default' : 'cursor-crosshair'}`} onMouseMove={handleMouseMove} onClick={handleFire} />

                            {/* Level 1 Overlay */}
                            {gameState === 'playing' && !showBriefing && LEVELS[currentLevel].mapType === 'explanation' && (
                                <div className="absolute bottom-2 left-0 right-0 flex justify-center pointer-events-none">
                                    <div className="bg-white/95 backdrop-blur-sm p-4 rounded-xl shadow-xl border border-blue-100 max-w-lg w-full text-center pointer-events-auto overflow-hidden mx-4">
                                        <div className="flex justify-between items-center mb-2 px-1">
                                            <h3 className="text-lg font-bold text-slate-800">CEP çš„æ©Ÿç‡å®šç¾©</h3>
                                            <button onClick={() => setShowCepModal(true)} className="text-blue-600 hover:text-blue-800 text-xs flex items-center gap-1 font-bold underline"><Icons.HelpCircle className="w-4 h-4"/> ä»€éº¼æ˜¯ CEP?</button>
                                        </div>
                                        <div className="flex flex-col sm:flex-row items-center justify-center gap-4 mb-4">
                                            <div className="flex items-center gap-2">
                                                <label className="text-sm font-bold text-gray-700 whitespace-nowrap">ç™¼å°„æ•¸é‡ï¼š</label>
                                                <div className="relative">
                                                    <select value={explanationMissileCount} onChange={(e) => setExplanationMissileCount(Number(e.target.value))} className="appearance-none bg-blue-50 border border-blue-200 text-blue-900 text-sm font-bold rounded py-1 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
                                                        {PROBABILITY_DATA.map(d => (<option key={d.count} value={d.count}>{d.count} æš</option>))}
                                                    </select>
                                                    <Icons.ChevronDown className="absolute right-1 top-1.5 w-4 h-4 text-blue-500 pointer-events-none"/>
                                                </div>
                                            </div>
                                            <button onClick={() => simulateOneVolley(explanationMissileCount)} className="flex items-center gap-1 bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-sm font-medium border border-gray-300 transition-colors"><Icons.RefreshCw className="w-4 h-4"/> å†æ¬¡ç™¼å°„</button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 mb-4 text-left bg-slate-50 p-3 rounded-lg border border-slate-100">
                                            <div><div className="text-xs text-gray-500">å®Œå…¨è„«é¶æ©Ÿç‡</div><div className="text-lg font-bold text-gray-700">{PROBABILITY_DATA[explanationMissileCount - 1].miss}</div></div>
                                            <div><div className="text-xs text-gray-500">è‡³å°‘å‘½ä¸­1ç™¼æ©Ÿç‡</div><div className="text-lg font-bold text-red-600">{PROBABILITY_DATA[explanationMissileCount - 1].hit}</div></div>
                                        </div>
                                        <p className="text-xs text-gray-500 mb-4 px-2">{explanationMissileCount === 1 ? "å–®ç™¼å‘½ä¸­ç‡åƒ… 50%ã€‚ç•«é¢ä¸­ç´…è‰²ç‚ºåœ“å…§å‘½ä¸­ï¼Œé»‘è‰²ç‚ºè„«é¶ã€‚" : `ç™¼å°„ ${explanationMissileCount} æšï¼Œç¢ºä¿å‘½ä¸­çš„æ©Ÿç‡å¤§å¹…æå‡ã€‚`}</p>
                                        <button onClick={() => startLevel(1)} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-bold shadow-lg flex items-center gap-2 mx-auto transition-transform hover:scale-105 text-sm">ä¸‹ä¸€æ­¥ï¼šå¯¦éš›é«”é©— CEP <Icons.ArrowRight className="w-4 h-4"/></button>
                                    </div>
                                </div>
                            )}

                            {/* Modal & Overlays */}
                            {showCepModal && (
                                <div className="absolute inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                                    <div className="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full relative animate-fadeIn">
                                        <button onClick={() => setShowCepModal(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icons.X className="w-6 h-6" /></button>
                                        <h3 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Icons.BookOpen className="text-blue-600 w-6 h-6"/> CEP (åœ“å‘¨èª¤å·®ç‡)</h3>
                                        <div className="text-gray-600 space-y-4 text-sm leading-relaxed text-left">
                                            <p><span className="font-bold text-gray-800">å®šç¾©ï¼š</span>CEP æ˜¯ä¸€å€‹çµ±è¨ˆå­¸åè©ã€‚å¦‚æœ CEP æ˜¯ 100 å…¬å°ºï¼Œä»£è¡¨ç™¼å°„å¾ˆå¤šæšé£›å½ˆå¾Œï¼Œ<span className="font-bold text-red-600">åªæœ‰ 50% æœƒè½åœ¨ç›®æ¨™ 100 å…¬å°ºçš„ç¯„åœå…§</span>ã€‚</p>
                                        </div>
                                        <button onClick={() => setShowCepModal(false)} className="mt-6 w-full bg-slate-800 text-white py-2 rounded font-bold hover:bg-slate-700">äº†è§£ï¼Œå›åˆ°æ¨¡æ“¬</button>
                                    </div>
                                </div>
                            )}

                            {gameState === 'playing' && !showBriefing && LEVELS[currentLevel].userCanSetCep && (
                                <div className="absolute top-4 right-4 bg-white/90 p-4 rounded-lg shadow-lg z-0 backdrop-blur-sm border border-gray-200">
                                    <h3 className="font-bold text-gray-700 mb-2 flex items-center gap-2"><Icons.MousePointer2 className="w-4 h-4"/> é¸æ“‡æƒ…å¢ƒ</h3>
                                    <div className="flex gap-2">
                                        <button onClick={(e) => { e.stopPropagation(); setSelectedCep(0); }} className={`px-3 py-1 rounded text-sm font-bold transition-colors ${selectedCep === 0 ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}>CEP = 0<br/><span className="text-xs font-normal">ç¶²è·¯è¬ è¨€</span></button>
                                        <button onClick={(e) => { e.stopPropagation(); setSelectedCep(100); }} className={`px-3 py-1 rounded text-sm font-bold transition-colors ${selectedCep === 100 ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}>CEP = 100<br/><span className="text-xs font-normal">ç¾å¯¦ä¸–ç•Œ</span></button>
                                    </div>
                                </div>
                            )}

                            {showBriefing && (
                                <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-8 z-10">
                                    <div className="bg-white max-w-lg w-full p-6 rounded-lg shadow-2xl text-center animate-fadeIn">
                                        <h2 className="text-2xl font-bold mb-2 text-slate-800">{LEVELS[currentLevel].title}</h2>
                                        <div className={`w-16 h-1 ${LEVELS[currentLevel].color.replace('bg-', 'bg-')} mx-auto mb-4 rounded bg-blue-500`}></div>
                                        <div className="mb-6 text-left bg-gray-50 p-5 rounded border-l-4 border-blue-500">
                                            <p className="text-gray-700 whitespace-pre-wrap leading-relaxed">{LEVELS[currentLevel].description}</p>
                                            <div className="mt-4 pt-4 border-t border-gray-200"><p className="text-sm text-slate-500 italic flex gap-2"><Icons.Info className="w-4 h-4 flex-shrink-0 mt-0.5"/>"{LEVELS[currentLevel].quote}"</p></div>
                                        </div>
                                        <button onClick={() => setShowBriefing(false)} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-full transition-all transform hover:scale-105 shadow-lg flex items-center gap-2 mx-auto"><Icons.Play className="w-5 h-5" fill="currentColor" /> {LEVELS[currentLevel].mapType === 'explanation' ? 'é–‹å§‹æ¼”ç¤º' : 'é–‹å§‹æ¨¡æ“¬'}</button>
                                    </div>
                                </div>
                            )}

                            {gameState === 'summary' && (
                                <div className="absolute inset-0 bg-black/85 flex items-center justify-center p-8 z-10">
                                    <div className="bg-white max-w-lg w-full p-6 rounded-lg shadow-2xl text-center">
                                        <h2 className="text-3xl font-bold mb-6 text-gray-800">æ¨¡æ“¬çµæŸ</h2>
                                        <div className="grid grid-cols-2 gap-4 mb-6">
                                            <div className="bg-green-50 p-4 rounded border border-green-100"><div className="text-4xl font-bold text-green-600">{militaryHits}</div><div className="text-sm text-gray-600 font-bold">æˆåŠŸå‘½ä¸­ç›®æ¨™</div></div>
                                            <div className="bg-red-50 p-4 rounded border border-red-100"><div className="text-4xl font-bold text-red-600">{civilianHits}</div><div className="text-sm text-gray-600 font-bold">èª¤æ“Šæ°‘ç”¨è¨­æ–½</div></div>
                                        </div>
                                        <div className="mb-8 text-left bg-orange-50 p-4 rounded border-l-4 border-orange-400">
                                            <h3 className="font-bold text-orange-800 mb-2">æˆ°è¡“åˆ†æ</h3>
                                            <p className="text-sm text-gray-700 leading-relaxed">
                                                {currentLevel === 1 && "é€™å°±æ˜¯ç¾å¯¦ã€‚å³ä½¿ç„æº–äº†ï¼Œåå·®ä»æœƒè®“é£›å½ˆè½åœ¨ç›®æ¨™å¤–ã€‚"}
                                                {currentLevel === 2 && "çœ‹åˆ°é‚£äº›è½åœ¨å­¸æ ¡æˆ–è¡—é“ä¸Šçš„é£›å½ˆäº†å—ï¼Ÿåœ¨éƒ½å¸‚å€ä½¿ç”¨å½ˆé“é£›å½ˆï¼Œä¼´éš¨çš„å°±æ˜¯é«˜åº¦çš„é™„å¸¶æå‚·èˆ‡æ”¿æ²»ä»£åƒ¹ã€‚"}
                                            </p>
                                        </div>
                                        <div className="flex justify-center gap-4">
                                            <button onClick={() => startLevel(currentLevel)} className="flex items-center gap-2 px-5 py-2 border border-gray-300 rounded hover:bg-gray-100 text-gray-600 font-medium transition-colors"><Icons.RotateCcw className="w-4 h-4"/> é‡è©¦æœ¬é—œ</button>
                                            <button onClick={returnToMenu} className="bg-slate-800 hover:bg-slate-900 text-white px-8 py-2 rounded font-bold shadow-md transition-colors flex items-center gap-2"><Icons.Home className="w-4 h-4"/> å›ä¸»é¸å–®</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {LEVELS[currentLevel].mapType !== 'explanation' && (
                                <div className="absolute top-4 left-4 flex flex-col gap-2 pointer-events-none">
                                    <div className="bg-black/70 text-white p-3 rounded-lg backdrop-blur-sm border border-white/10 shadow-lg">
                                        <div className="text-xs text-gray-300 uppercase tracking-wider mb-1">Missiles Left</div>
                                        <div className="text-3xl font-mono text-red-400 font-bold">{missilesLeft}</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* --- CONTROL PANEL --- */}
                    {gameState !== 'menu' && gameState !== 'bibliography' && LEVELS[currentLevel].mapType !== 'explanation' && (
                        <div className="p-4 bg-gray-50 border-t border-gray-200 shrink-0">
                            <div className="flex gap-6 h-32">
                                <div className="w-1/3 flex flex-col justify-between">
                                    <div>
                                        <h3 className="font-bold text-gray-700 flex items-center gap-2 mb-2"><Icons.Target className="text-blue-600 w-4 h-4"/> æ“ä½œèªªæ˜</h3>
                                        <p className="text-sm text-gray-600 leading-relaxed">{currentLevel === 1 ? "å³ä¸Šè§’å¯åˆ‡æ› CEP æ¨¡å¼ã€‚é»æ“Šç•«é¢ç™¼å°„é£›å½ˆã€‚" : "ç§»å‹•æ»‘é¼ ç„æº–ï¼Œé»æ“Šå·¦éµç™¼å°„ã€‚ç´…è‰²åœ“åœˆç‚º CEP (50% è½é»æ©Ÿç‡ç¯„åœ)ã€‚"}</p>
                                    </div>
                                    <div className="mt-2">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1"><span>ç²¾æº– (0m)</span><span>åå·® ({selectedCep}m)</span></div>
                                        <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div className="bg-gradient-to-r from-green-500 to-red-500 h-full transition-all duration-500" style={{width: `${Math.min((selectedCep / 200) * 100, 100)}%`}}></div></div>
                                    </div>
                                </div>
                                <div className="w-2/3 bg-slate-900 text-green-400 font-mono text-sm p-3 rounded shadow-inner overflow-y-auto leading-snug">
                                    {logs.length === 0 ? <div className="h-full flex items-center justify-center opacity-30 text-center">-- ç­‰å¾…æˆ°è¡“æŒ‡ä»¤ --<br/>READY TO FIRE</div> : logs.map((log, i) => <div key={i} className="border-b border-gray-800 pb-1 mb-1 last:border-0 hover:bg-white/5 transition-colors"><span className="opacity-50 mr-2">[{logs.length - i}]</span>{log}</div>)}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
